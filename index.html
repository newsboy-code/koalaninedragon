<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‰´ìŠ¤ë³´ì´ ì½”ì•Œë¼: êµ¬ë£¡íˆ¬</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg: #eceff1;
            --black-koala: #263238; /* í™€ìˆ˜ */
            --white-koala: #ffffff; /* ì§ìˆ˜ */
            --point: #d32f2f;
        }

        body {
            font-family: 'Pretendard', sans-serif; background: var(--bg);
            margin: 0; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden;
        }

        /* ë¡œë¹„ */
        #lobby {
            position: fixed; inset: 0; background: white; z-index: 1000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px;
        }

        /* ê²Œì„íŒ */
        #game-board { display: none; width: 100%; max-width: 500px; height: 100%; flex-direction: column; }
        
        .header {
            padding: 15px; display: flex; justify-content: space-between; background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-weight: bold;
        }

        #arena { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 20px; }
        
        .status-text { font-weight: bold; color: var(--point); margin-bottom: 10px; font-size: 1.1rem; }

        /* ì¹´ë“œ ë””ìì¸ */
        .card {
            width: 80px; height: 115px; border-radius: 12px; display: flex;
            justify-content: center; align-items: center; font-size: 2.2rem; font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: 0.3s;
        }
        
        /* ì•„ë ˆë‚˜ ì¹´ë“œ (ë’·ë©´ ìœ ì§€) */
        .spot { border: 2px dashed #cfd8dc; visibility: hidden; }
        .spot.visible { visibility: visible; }
        .spot.back { color: white; }
        .spot.back.odd { background: var(--black-koala); border-color: #000; }
        .spot.back.even { background: var(--white-card); border-color: #b0bec5; color: #263238; }

        /* ë‚´ ì†íŒ¨ */
        .hand-area {
            padding: 20px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;
            background: white; border-radius: 20px 20px 0 0;
        }
        .hand-card {
            background: white; border: 1px solid #ddd; cursor: pointer; font-size: 1.4rem;
            height: 80px; display: flex; justify-content: center; align-items: center; border-radius: 8px;
        }
        .hand-card.odd { border-bottom: 5px solid var(--black-koala); }
        .hand-card.even { border-bottom: 5px solid #b0bec5; }
        .hand-card.used { opacity: 0.15; pointer-events: none; }

        /* ê²°ê³¼ ë³µê¸°ìš© */
        #final-review {
            position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 2000;
            display: none; flex-direction: column; align-items: center; padding: 20px; overflow-y: auto;
        }
        .review-row { display: flex; gap: 20px; margin-bottom: 10px; align-items: center; border-bottom: 1px solid #eee; padding: 5px; }

        .btn { padding: 12px 24px; background: var(--point); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div id="lobby">
        <h1>ğŸ¨ ë‰´ìŠ¤ë³´ì´ ì½”ì•Œë¼ êµ¬ë£¡íˆ¬</h1>
        <p>ìƒëŒ€ì˜ <b>ìˆ«ì</b>ëŠ” ë§ˆì§€ë§‰ê¹Œì§€ ê³µê°œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
        <div style="background: #f1f1f1; padding: 15px; border-radius: 10px; margin: 20px 0;">
            <small>ë‚´ ì ‘ì† ID</small><br>
            <strong id="my-id">ì—°ê²° ì¤‘...</strong>
        </div>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="peer-input" placeholder="ìƒëŒ€ ID" style="padding: 10px; width: 120px;">
            <button class="btn" onclick="connect()">ê²Œì„ ì‹œì‘</button>
        </div>
    </div>

    <div id="game-board">
        <div class="header">
            <div>ë‚˜: <span id="my-score">0</span></div>
            <div id="round-num">ROUND 1</div>
            <div>ìƒëŒ€: <span id="op-score">0</span></div>
        </div>
        <div id="arena">
            <div id="status" class="status-text">ì ‘ì† ëŒ€ê¸° ì¤‘...</div>
            <div style="display: flex; gap: 30px;">
                <div id="op-spot" class="card spot">ğŸ¨</div>
                <div id="my-spot" class="card spot"></div>
            </div>
        </div>
        <div id="my-hand" class="hand-area"></div>
    </div>

    <div id="final-review">
        <h2>ì „íˆ¬ ë³µê¸°</h2>
        <div id="review-list"></div>
        <button class="btn" onclick="location.reload()" style="margin-top: 20px;">ìƒˆ ê²Œì„ í•˜ê¸°</button>
    </div>

    <script>
        let peer, conn;
        let myS = 0, opS = 0, round = 1;
        let isAttacker = false;
        let myVal = null, opColor = null, opVal = null;
        let history = []; // {round, my, op, result}

        peer = new Peer();
        peer.on('open', id => document.getElementById('my-id').innerText = id);
        peer.on('connection', c => { conn = c; init(false); });

        function connect() {
            const tid = document.getElementById('peer-input').value;
            if(!tid) return;
            conn = peer.connect(tid);
            init(true);
        }

        function init(attacker) {
            conn.on('open', () => {
                document.getElementById('lobby').style.display = 'none';
                document.getElementById('game-board').style.display = 'flex';
                isAttacker = attacker;
                renderHand();
                updateMsg();
            });

            conn.on('data', data => {
                if(data.type === 'COMMIT') {
                    opColor = data.color;
                    const spot = document.getElementById('op-spot');
                    spot.className = `card spot visible back ${opColor}`;
                    if(myVal) conn.send({type: 'COMPARE', val: myVal});
                    else document.getElementById('status').innerText = "ìƒëŒ€ê°€ ëƒˆìŠµë‹ˆë‹¤! ëŒ€ì‘í•˜ì„¸ìš”.";
                } else if(data.type === 'COMPARE') {
                    opVal = data.val;
                    calcResult();
                }
            });
        }

        function renderHand() {
            const h = document.getElementById('my-hand');
            h.innerHTML = '';
            for(let i=1; i<=9; i++) {
                const c = document.createElement('div');
                c.className = `hand-card ${i%2===0?'even':'odd'}`;
                c.innerText = i;
                c.id = `card-${i}`;
                c.onclick = () => {
                    if(!isAttacker && !opColor) return alert("ê³µê²©ìê°€ ë¨¼ì € ë‚´ì•¼ í•©ë‹ˆë‹¤.");
                    if(myVal) return;
                    myVal = i;
                    c.classList.add('used');
                    const mSpot = document.getElementById('my-spot');
                    mSpot.className = `card spot visible back ${i%2===0?'even':'odd'}`;
                    mSpot.innerText = "ğŸ¨"; // ê²Œì„ ì¤‘ì—ëŠ” ë‚´ ì¹´ë“œë„ ìˆ«ìë¥¼ ê°€ë¦½ë‹ˆë‹¤(ê¸´ì¥ê° ìœ„í•´)
                    conn.send({type: 'COMMIT', color: i%2===0?'even':'odd'});
                    if(opColor) conn.send({type: 'COMPARE', val: myVal});
                    else document.getElementById('status').innerText = "ìƒëŒ€ì˜ ëŒ€ì‘ ëŒ€ê¸° ì¤‘...";
                };
                h.appendChild(c);
            }
        }

        function calcResult() {
            let win = false, draw = false;
            if(myVal === opVal) draw = true;
            else if(myVal === 1 && opVal === 9) win = true;
            else if(myVal === 9 && opVal === 1) win = false;
            else win = myVal > opVal;

            const resStr = draw ? "ë¬´ìŠ¹ë¶€" : (win ? "ìŠ¹ë¦¬" : "íŒ¨ë°°");
            history.push({r: round, my: myVal, op: opVal, res: resStr});

            setTimeout(() => {
                alert(`ë¼ìš´ë“œ ${round} ê²°ê³¼: ${resStr}\n(ìƒëŒ€ì˜ ìˆ«ìëŠ” ë¹„ë°€ì…ë‹ˆë‹¤!)`);
                if(!draw) {
                    if(win) { myS++; isAttacker = true; }
                    else { opS++; isAttacker = false; }
                }
                next();
            }, 500);
        }

        function next() {
            if(round >= 9) return finish();
            round++;
            myVal = null; opVal = null; opColor = null;
            document.getElementById('my-score').innerText = myS;
            document.getElementById('op-score').innerText = opS;
            document.getElementById('round-num').innerText = `ROUND ${round}`;
            document.getElementById('my-spot').className = "card spot";
            document.getElementById('op-spot').className = "card spot";
            updateMsg();
        }

        function finish() {
            document.getElementById('game-board').style.display = 'none';
            const f = document.getElementById('final-review');
            f.style.display = 'flex';
            const list = document.getElementById('review-list');
            let html = `<h3>ìµœì¢… ìŠ¤ì½”ì–´ - ë‚˜: ${myS} vs ìƒëŒ€: ${opS}</h3>`;
            history.forEach(h => {
                html += `<div class="review-row">
                    <b>R${h.r}</b> 
                    <span>ë‚˜: ${h.my}</span> vs <span>ìƒëŒ€: ${h.op}</span> 
                    <strong style="color:var(--point)">[${h.res}]</strong>
                </div>`;
            });
            list.innerHTML = html;
        }

        function updateMsg() {
            document.getElementById('status').innerText = isAttacker ? "ë‹¹ì‹ ì´ ê³µê²©(ì„ ê³µ)ì…ë‹ˆë‹¤" : "ìƒëŒ€ì˜ ì„ ê³µì„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤";
        }
    </script>
</body>
</html>
