<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‰´ìŠ¤ë³´ì´ ì½”ì•Œë¼: êµ¬ë£¡íˆ¬</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --black-card: #343a40; /* í™€ìˆ˜: ë‹¤í¬ ê·¸ë ˆì´ */
            --white-card: #ffffff; /* ì§ìˆ˜: í™”ì´íŠ¸ */
            --accent-color: #e63946;
            --text-main: #212529;
        }

        body {
            font-family: 'Pretendard', -apple-system, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            color: var(--text-main);
            overflow: hidden;
        }

        /* ë¡œë¹„ ë° ì ‘ì† í™”ë©´ */
        #lobby {
            position: fixed;
            inset: 0;
            background: white;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
        }

        .input-group {
            margin: 20px 0;
            display: flex;
            gap: 10px;
        }

        input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        /* ê²Œì„ ë³´ë“œ ë ˆì´ì•„ì›ƒ */
        #game-board {
            display: none;
            width: 100%;
            max-width: 500px;
            height: 100%;
            flex-direction: column;
        }

        .header {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            font-weight: bold;
        }

        /* ì•„ë ˆë‚˜ (ì „íˆ¬ êµ¬ì—­) */
        #arena {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 30px;
        }

        #status-msg {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent-color);
            height: 1.5rem;
        }

        .battle-zone {
            display: flex;
            gap: 40px;
        }

        /* ì¹´ë“œ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .card {
            width: 70px;
            height: 100px;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            user-select: none;
            border: 2px solid transparent;
        }

        /* ì¹´ë“œ ì•ë©´ (ë‚˜ë§Œ ë´„) */
        .card.my-hand-card { background: white; border-color: #eee; }
        .card.my-hand-card.odd { border-bottom: 5px solid var(--black-card); }
        .card.my-hand-card.even { border-bottom: 5px solid #ccc; }
        .card.used { opacity: 0.3; pointer-events: none; transform: scale(0.9); }

        /* ì¹´ë“œ ë’·ë©´ (ì½”ì•Œë¼ ğŸ¨) */
        .card.back { font-size: 2.5rem; cursor: default; }
        .card.back.odd { background-color: var(--black-card); border-color: #000; }
        .card.back.even { background-color: var(--white-card); border-color: #ddd; }

        /* ì†íŒ¨ êµ¬ì—­ */
        .hand-container {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            background: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
        }

        .btn {
            padding: 12px 24px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }

        .btn:disabled { background: #ccc; }

        .score-box { font-size: 1.2rem; }
    </style>
</head>
<body>

    <div id="lobby">
        <h1>ğŸ¨ ì½”ì•Œë¼ êµ¬ë£¡íˆ¬</h1>
        <p>ì¹œêµ¬ì—ê²Œ ë‚´ IDë¥¼ ì•Œë ¤ì£¼ê±°ë‚˜, ì¹œêµ¬ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
        <div style="background: #f0f0f0; padding: 10px; border-radius: 8px; margin: 10px;">
            <small>ë‚´ ì ‘ì† ID</small><br>
            <strong id="my-peer-id">...ì—°ê²°ì¤‘</strong>
        </div>
        <div class="input-group">
            <input type="text" id="target-id" placeholder="ì¹œêµ¬ ID ì…ë ¥">
            <button class="btn" onclick="startConnect()">ëŒ€ì „ ì‹ ì²­</button>
        </div>
        <div style="font-size: 0.85rem; color: #666; line-height: 1.6;">
            <strong>[ê·œì¹™]</strong><br>
            í™€ìˆ˜: ë¸”ë™ ğŸ¨ / ì§ìˆ˜: í™”ì´íŠ¸ ğŸ¨<br>
            ìˆ«ìê°€ í¬ë©´ ìŠ¹ë¦¬! (ë‹¨, <strong>1ì€ 9ë¥¼ ì´ê¹ë‹ˆë‹¤</strong>)
        </div>
    </div>

    <div id="game-board">
        <div class="header">
            <div class="score-box">ë‚˜: <span id="my-score">0</span></div>
            <div id="round-info">ROUND 1/9</div>
            <div class="score-box">ìƒëŒ€: <span id="op-score">0</span></div>
        </div>

        <div id="arena">
            <div id="status-msg">ìƒëŒ€ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</div>
            <div class="battle-zone">
                <div>
                    <small>ìƒëŒ€</small>
                    <div id="op-spot" class="card back" style="visibility: hidden;">ğŸ¨</div>
                </div>
                <div>
                    <small>ë‚˜</small>
                    <div id="my-spot" class="card" style="visibility: hidden;"></div>
                </div>
            </div>
        </div>

        <div class="hand-container" id="my-hand">
            </div>
    </div>

    <script>
        let peer, conn;
        let myScore = 0, opScore = 0;
        let round = 1;
        let isMyTurn = false;
        let myPlayedValue = null;
        let opValue = null;

        // PeerJS ì´ˆê¸°í™”
        peer = new Peer();
        peer.on('open', id => document.getElementById('my-peer-id').innerText = id);

        // ìƒëŒ€ë°©ì˜ ì ‘ì† ëŒ€ê¸°
        peer.on('connection', c => {
            conn = c;
            initCommunication();
            startGame(false); // ìˆ˜ë¹„ìë¡œ ì‹œì‘
        });

        function startConnect() {
            const tid = document.getElementById('target-id').value;
            if(!tid) return alert("IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            conn = peer.connect(tid);
            initCommunication();
            startGame(true); // ê³µê²©ìë¡œ ì‹œì‘
        }

        function initCommunication() {
            conn.on('open', () => {
                document.getElementById('lobby').style.display = 'none';
                document.getElementById('game-board').style.display = 'flex';
                renderHand();
            });

            conn.on('data', data => {
                if (data.type === 'play') {
                    // ìƒëŒ€ê°€ ì¹´ë“œë¥¼ ëƒ„ (ìƒ‰ê¹”ë§Œ ë…¸ì¶œ)
                    showOpCard(data.color);
                    if (myPlayedValue) {
                        conn.send({type: 'reveal', value: myPlayedValue});
                    }
                } else if (data.type === 'reveal') {
                    // ìƒëŒ€ê°€ ì‹¤ì œ ìˆ«ìë¥¼ ê³µê°œí•¨
                    resolveRound(data.value);
                }
            });
        }

        function startGame(attacker) {
            isMyTurn = attacker;
            updateStatus();
        }

        function renderHand() {
            const container = document.getElementById('my-hand');
            container.innerHTML = '';
            for(let i=1; i<=9; i++) {
                const c = document.createElement('div');
                c.className = `card my-hand-card ${i%2===0?'even':'odd'}`;
                c.innerText = i;
                c.id = `hand-${i}`;
                c.onclick = () => playCard(i);
                container.appendChild(c);
            }
        }

        function playCard(val) {
            if (!isMyTurn && !document.getElementById('op-spot').style.visibility === 'visible') {
                return alert("ìƒëŒ€ê°€ ë¨¼ì € ë‚´ì•¼ í•©ë‹ˆë‹¤.");
            }
            if (myPlayedValue !== null) return;

            myPlayedValue = val;
            document.getElementById(`hand-${val}`).classList.add('used');
            
            // ë‚´ ì¹´ë“œ ì•„ë ˆë‚˜ì— í‘œì‹œ
            const mySpot = document.getElementById('my-spot');
            mySpot.style.visibility = 'visible';
            mySpot.innerText = val;
            mySpot.className = `card ${val%2===0?'even':'odd'}`;

            // ìƒëŒ€ì—ê²Œ ì „ì†¡ (ìƒ‰ê¹”ë§Œ)
            conn.send({type: 'play', color: val%2===0?'even':'odd'});

            if (!isMyTurn) {
                // ë‚´ê°€ ìˆ˜ë¹„ìì˜€ìœ¼ë©´ ë°”ë¡œ ìˆ«ì ê³µê°œ ìš”ì²­
                conn.send({type: 'reveal', value: myPlayedValue});
            } else {
                document.getElementById('status-msg').innerText = "ìƒëŒ€ì˜ ì„ íƒì„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤...";
            }
        }

        function showOpCard(color) {
            const opSpot = document.getElementById('op-spot');
            opSpot.style.visibility = 'visible';
            opSpot.className = `card back ${color}`;
            opSpot.innerText = "ğŸ¨";
            document.getElementById('status-msg').innerText = "ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”!";
        }

        function resolveRound(receivedOpValue) {
            opValue = receivedOpValue;
            const opSpot = document.getElementById('op-spot');
            opSpot.innerText = opValue;
            opSpot.classList.remove('back');

            let win = false;
            let draw = false;

            if (myPlayedValue === opValue) draw = true;
            else if (myPlayedValue === 1 && opValue === 9) win = true;
            else if (myPlayedValue === 9 && opValue === 1) win = false;
            else win = myPlayedValue > opValue;

            setTimeout(() => {
                if(draw) {
                    alert(`ë¬´ìŠ¹ë¶€! (${myPlayedValue} vs ${opValue})`);
                } else if(win) {
                    alert(`ìŠ¹ë¦¬! (${myPlayedValue} vs ${opValue})`);
                    myScore++;
                    isMyTurn = true;
                } else {
                    alert(`íŒ¨ë°°... (${myPlayedValue} vs ${opValue})`);
                    opScore++;
                    isMyTurn = false;
                }
                nextRound();
            }, 500);
        }

        function nextRound() {
            myPlayedValue = null;
            round++;
            
            document.getElementById('my-score').innerText = myScore;
            document.getElementById('op-score').innerText = opScore;
            document.getElementById('my-spot').style.visibility = 'hidden';
            document.getElementById('op-spot').style.visibility = 'hidden';

            if (round > 9) {
                const final = myScore > opScore ? "ì¶•í•˜í•©ë‹ˆë‹¤! ìµœì¢… ìŠ¹ë¦¬!" : (myScore === opScore ? "ë¬´ìŠ¹ë¶€ì…ë‹ˆë‹¤." : "ì•„ì‰½ë„¤ìš”. ìµœì¢… íŒ¨ë°°...");
                alert(`ê²Œì„ ì¢…ë£Œ\n${final}`);
                location.reload();
            } else {
                document.getElementById('round-info').innerText = `ROUND ${round}/9`;
                updateStatus();
            }
        }

        function updateStatus() {
            document.getElementById('status-msg').innerText = isMyTurn ? "ë‹¹ì‹ ì´ ê³µê²©í•  ì°¨ë¡€ì…ë‹ˆë‹¤" : "ìƒëŒ€ì˜ ê³µê²©ì„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤";
        }
    </script>
</body>
</html>