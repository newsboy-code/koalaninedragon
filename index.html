<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‰´ìŠ¤ë³´ì´ ì½”ì•Œë¼: êµ¬ë£¡íˆ¬</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root {
            --bg: #f0f2f5;
            --black-koala: #212121;
            --white-koala: #ffffff;
            --accent: #d32f2f;
        }

        body {
            font-family: 'Pretendard', sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh; /* ëª¨ë°”ì¼ ê°€ë³€ ë†’ì´ ëŒ€ì‘ */
            overflow: hidden;
        }

        /* ë¡œë¹„/ì ‘ì† í™”ë©´ */
        #lobby {
            position: fixed; inset: 0; background: white; z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px;
        }

        /* ìƒë‹¨ ìƒíƒœë°” */
        .header {
            height: 60px; background: white; display: flex;
            justify-content: space-between; align-items: center;
            padding: 0 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-weight: bold; z-index: 100;
        }

        /* ë©”ì¸ ì•„ë ˆë‚˜ */
        #arena {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 15px;
            padding: 10px;
        }

        .status-msg { font-weight: bold; color: var(--accent); font-size: 1rem; text-align: center; height: 1.2rem; }

        .battle-zone { display: flex; gap: 20px; align-items: center; }

        /* ì¹´ë“œ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .card {
            width: 75px; height: 105px; border-radius: 12px;
            display: flex; justify-content: center; align-items: center;
            font-size: 2.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: relative; border: 2px solid transparent;
        }
        .card.spot { visibility: hidden; }
        .card.visible { visibility: visible; }
        .card.back.odd { background: var(--black-koala); color: white; border-color: #000; }
        .card.back.even { background: var(--white-koala); color: #212121; border-color: #ccc; }

        /* í•˜ë‹¨ ì†íŒ¨ ì˜ì—­ (ëª¨ë°”ì¼ ê³ ì • í•µì‹¬) */
        #my-hand {
            background: white;
            padding: 15px 10px env(safe-area-inset-bottom); /* ì•„ì´í° í•˜ë‹¨ ë°” ëŒ€ì‘ */
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            border-top: 1px solid #ddd;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        .hand-card {
            aspect-ratio: 2/3;
            background: white;
            border: 1px solid #eee;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }
        .hand-card.odd { border-bottom: 5px solid var(--black-koala); }
        .hand-card.even { border-bottom: 5px solid #ccc; }
        .hand-card.used { opacity: 0.1; pointer-events: none; }

        /* ìµœì¢… ë¦¬ë·° ëª¨ë‹¬ */
        #final-review {
            position: fixed; inset: 0; background: white; z-index: 3000;
            display: none; flex-direction: column; padding: 20px; overflow-y: auto;
        }
        .review-item { display: flex; justify-content: space-around; padding: 12px; border-bottom: 1px solid #eee; }

        .btn { padding: 12px 20px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        input { padding: 12px; border: 1px solid #ddd; border-radius: 8px; width: 140px; }
    </style>
</head>
<body>

    <div id="lobby">
        <h1 style="margin-bottom:10px;">ğŸ¨ ë‰´ìŠ¤ë³´ì´ ì½”ì•Œë¼</h1>
        <p style="color:#666; font-size:0.9rem;">ìˆ«ìëŠ” ê²Œì„ ì¢…ë£Œ í›„ í•œêº¼ë²ˆì— ê³µê°œë©ë‹ˆë‹¤.</p>
        <div style="background:#f8f9fa; padding:15px; border-radius:12px; margin:20px 0; width:100%; max-width:280px;">
            <small>ë‚´ ì ‘ì† ID</small><br>
            <strong id="my-id" style="font-size:1.1rem; color:var(--black-koala);">ì—°ê²° ì¤‘...</strong>
        </div>
        <div style="display:flex; gap:8px;">
            <input type="text" id="target-id" placeholder="ì¹œêµ¬ ID ì…ë ¥">
            <button class="btn" onclick="connect()">ëŒ€ì „ ì‹œì‘</button>
        </div>
    </div>

    <div id="game-board" style="display:none; flex-direction:column; height:100%;">
        <div class="header">
            <div>ë‚˜: <span id="my-score">0</span></div>
            <div id="round-info">ROUND 1</div>
            <div>ìƒëŒ€: <span id="op-score">0</span></div>
        </div>

        <div id="arena">
            <div id="status-msg" class="status-msg">ìƒëŒ€ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</div>
            <div class="battle-zone">
                <div style="text-align:center;">
                    <small style="color:#888;">ìƒëŒ€</small>
                    <div id="op-spot" class="card spot">ğŸ¨</div>
                </div>
                <div style="text-align:center;">
                    <small style="color:#888;">ë‚˜</small>
                    <div id="my-spot" class="card spot">ğŸ¨</div>
                </div>
            </div>
        </div>

        <div id="my-hand"></div>
    </div>

    <div id="final-review">
        <h2 style="text-align:center;">ì „íˆ¬ ë³µê¸°</h2>
        <div id="review-list"></div>
        <button class="btn" onclick="location.reload()" style="margin-top:20px;">ìƒˆ ê²Œì„ ì‹œì‘</button>
    </div>

    <script>
        let peer, conn;
        let myScore = 0, opScore = 0, round = 1;
        let isAttacker = false;
        let myVal = null, opColor = null, opVal = null;
        let history = [];

        peer = new Peer();
        peer.on('open', id => document.getElementById('my-id').innerText = id);
        peer.on('connection', c => { conn = c; setup(false); });

        function connect() {
            const tid = document.getElementById('target-id').value;
            if(!tid) return;
            conn = peer.connect(tid);
            setup(true);
        }

        function setup(attacker) {
            conn.on('open', () => {
                document.getElementById('lobby').style.display = 'none';
                document.getElementById('game-board').style.display = 'flex';
                isAttacker = attacker;
                renderHand();
                updateStatus();
            });

            conn.on('data', data => {
                if(data.type === 'COMMIT') {
                    opColor = data.color;
                    const spot = document.getElementById('op-spot');
                    spot.className = `card spot visible back ${opColor}`;
                    if(myVal) conn.send({type: 'COMPARE', val: myVal});
                    else document.getElementById('status-msg').innerText = "ìƒëŒ€ê°€ ëƒˆìŠµë‹ˆë‹¤! ëŒ€ì‘í•˜ì„¸ìš”.";
                } else if(data.type === 'COMPARE') {
                    opVal = data.val;
                    resolveRound();
                }
            });
        }

        function renderHand() {
            const container = document.getElementById('my-hand');
            container.innerHTML = '';
            for(let i=1; i<=9; i++) {
                const c = document.createElement('div');
                c.className = `hand-card ${i%2===0?'even':'odd'}`;
                c.innerText = i;
                c.id = `h-${i}`;
                c.onclick = () => {
                    if(!isAttacker && !opColor) return alert("ìƒëŒ€ë°©(ê³µê²©ì)ì´ ë¨¼ì € ë‚´ì•¼ í•©ë‹ˆë‹¤.");
                    if(myVal) return;
                    myVal = i;
                    c.classList.add('used');
                    const mSpot = document.getElementById('my-spot');
                    mSpot.className = `card spot visible back ${i%2===0?'even':'odd'}`;
                    conn.send({type: 'COMMIT', color: i%2===0?'even':'odd'});
                    if(opColor) conn.send({type: 'COMPARE', val: myVal});
                    else document.getElementById('status-msg').innerText = "ìƒëŒ€ì˜ ëŒ€ì‘ ëŒ€ê¸° ì¤‘...";
                };
                container.appendChild(c);
            }
        }

        function resolveRound() {
            let win = false, draw = false;
            if(myVal === opVal) draw = true;
            else if(myVal === 1 && opVal === 9) win = true;
            else if(myVal === 9 && opVal === 1) win = false;
            else win = myVal > opVal;

            const res = draw ? "ë¬´ìŠ¹ë¶€" : (win ? "ìŠ¹ë¦¬" : "íŒ¨ë°°");
            history.push({r: round, my: myVal, op: opVal, res: res});

            setTimeout(() => {
                alert(`ë¼ìš´ë“œ ${round} ê²°ê³¼: ${res}\n(ìƒëŒ€ì˜ ìˆ«ìëŠ” ë§ˆì§€ë§‰ì— ê³µê°œë©ë‹ˆë‹¤)`);
                if(!draw) {
                    if(win) { myScore++; isAttacker = true; }
                    else { opScore++; isAttacker = false; }
                }
                nextRound();
            }, 500);
        }

        function nextRound() {
            if(round >= 9) return showFinal();
            round++;
            myVal = null; opVal = null; opColor = null;
            document.getElementById('my-score').innerText = myScore;
            document.getElementById('op-score').innerText = opScore;
            document.getElementById('round-info').innerText = `ROUND ${round}`;
            document.getElementById('my-spot').className = "card spot";
            document.getElementById('op-spot').className = "card spot";
            updateStatus();
        }

        function showFinal() {
            document.getElementById('game-board').style.display = 'none';
            const review = document.getElementById('final-review');
            review.style.display = 'flex';
            let html = `<h3 style="text-align:center;">ìµœì¢… ê²°ê³¼: ${myScore > opScore ? 'ìŠ¹ë¦¬!' : (myScore === opScore ? 'ë¬´ìŠ¹ë¶€' : 'íŒ¨ë°°')}</h3>`;
            history.forEach(h => {
                html += `<div class="review-item">
                    <span>R${h.r}</span>
                    <span>ë‚˜: <b>${h.my}</b></span>
                    <span>ìƒëŒ€: <b>${h.op}</b></span>
                    <span style="color:var(--accent)">${h.res}</span>
                </div>`;
            });
            document.getElementById('review-list').innerHTML = html;
        }

        function updateStatus() {
            document.getElementById('status-msg').innerText = isAttacker ? "ë‹¹ì‹ ì´ ê³µê²©í•  ì°¨ë¡€ì…ë‹ˆë‹¤" : "ìƒëŒ€ì˜ ì„ ê³µì„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤";
        }
    </script>
</body>
</html>
